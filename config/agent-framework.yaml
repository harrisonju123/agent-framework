# Agent Framework Configuration
# Copy this file to agent-framework.yaml and customize as needed

workspace: "."
communication_dir: ".agent-communication"

# LLM Configuration
llm:
  # Mode: "claude_cli" (Claude Code subprocess) or "litellm" (API calls)
  mode: claude_cli

  # Proxy: route Claude CLI API calls through LiteLLM proxy for billing/routing
  # Only applies when mode: claude_cli
  # proxy_url: ${LITELLM_PROXY_URL}
  # proxy_auth_token: ${LITELLM_AUTH_TOKEN}

  # Claude CLI settings (used when mode=claude_cli)
  claude_cli_executable: claude
  claude_cli_max_turns: 999
  claude_cli_timeout: 3600  # Default fallback timeout (1 hour)

  # Task-type-specific timeouts (prevents vague tasks from running too long)
  # Large: IMPLEMENTATION, ARCHITECTURE, ANALYSIS, PLANNING, ESCALATION, ENHANCEMENT
  # Bounded: TESTING, VERIFICATION, FIX, BUGFIX, REVIEW, PR_REQUEST
  # Simple: DOCUMENTATION, COORDINATION, STATUS_REPORT
  claude_cli_timeout_large: 3600   # 1 hour
  claude_cli_timeout_bounded: 1800 # 30 minutes
  claude_cli_timeout_simple: 900   # 15 minutes

  claude_cli_cheap_model: claude-3-5-haiku-20241022
  claude_cli_default_model: claude-sonnet-4-20250514
  claude_cli_premium_model: claude-sonnet-4-20250514

  # LiteLLM direct settings (used when mode=litellm)
  # pip install 'agent-framework[litellm]' required
  # litellm_api_key: ${LITELLM_API_KEY}
  # litellm_api_base: ${LITELLM_API_BASE}
  # litellm_cheap_model: claude-haiku-4-5-20251001
  # litellm_default_model: claude-sonnet-4-5-20250929
  # litellm_premium_model: claude-sonnet-4-5-20250929

  # MCP (Model Context Protocol) settings
  # Enables real-time JIRA/GitHub access during agent execution
  # Requires mode: claude_cli
  use_mcp: true
  mcp_config_path: /Users/hju/PycharmProjects/agent-framework/config/mcp-config.json

# Task Processing Configuration
task:
  poll_interval: 30          # Queue polling interval (seconds)
  timeout: 3600              # Task timeout (seconds, default: 1 hour)
  max_retries: 5             # Max retry attempts before escalation
  backoff_initial: 30        # Initial backoff delay (seconds)
  backoff_max: 240           # Max backoff delay (seconds)
  backoff_multiplier: 2      # Backoff multiplier (exponential)

  # Task validation (prevents vague/underspecified tasks from processing)
  # Only validates agent-generated tasks; JIRA tickets are skipped
  validate_tasks: true
  validation_mode: warn      # "warn" logs warning, "reject" fails the task

# Safeguards Configuration
safeguards:
  max_queue_size: 100        # Max tasks per agent queue
  max_escalations: 50        # Max total escalations
  max_task_age_days: 7       # Archive tasks older than N days
  heartbeat_timeout: 600     # Agent considered dead after N seconds (10 min for long MCP tasks)
  watchdog_interval: 60      # Watchdog check interval (seconds)

# Optimization Configuration
# Token usage optimizations for reducing prompt size and costs
optimization:
  # Quick wins (Phase 1)
  enable_minimal_prompts: false           # Strategy 1: Reduce task JSON to essential fields only
  enable_compact_json: false              # Strategy 4: Remove whitespace from JSON in prompts
  enable_context_deduplication: false     # Strategy 3: Eliminate description/context duplication

  # Structural changes (Phase 2)
  enable_token_tracking: false            # Strategy 6: Track token usage per task
  enable_token_budget_warnings: false     # Strategy 6: Warn when tasks exceed budget

  # Advanced features (Phase 3)
  enable_result_summarization: false      # Strategy 5: Extract and reuse task outcomes
  enable_error_truncation: false          # Strategy 8: Truncate large error messages

  # Rollout settings
  canary_percentage: 0  # 0-100, percentage of tasks to use optimizations (0=disabled, 100=all)
  shadow_mode: false    # If true, generate both prompts but use legacy (for validation)

  # Budget warning threshold (e.g., 1.3 = warn at 130% of budget)
  budget_warning_threshold: 1.3  # Default: warn at 30% over budget

  # Token budgets by task type (optional, uses sensible defaults if not specified)
  # Customize these if your tasks consistently need more/less tokens
  # token_budgets:
  #   planning: 30000
  #   implementation: 50000
  #   testing: 20000
  #   escalation: 80000
  #   review: 25000

# Team mode: use Claude Agent Teams for multi-agent workflows
# When enabled, standard/full workflow tasks run as a team session
# instead of bouncing between queues
team_mode:
  enabled: true           # Teams handle full workflow in one session
  min_workflow: standard  # minimum workflow complexity to trigger teams
  # simple = never use teams (single-agent)
  # standard = engineer + QA team
  # full = architect + engineer + QA team

# Multi-Repository Configuration
# Used by the 'agent apply-pattern' command
multi_repo:
  workspace_root: "~/.agent-workspaces"  # Where to clone repos for multi-repo operations

  # Git worktree configuration for isolated agent workspaces
  # Each parallel task gets its own worktree (separate branch, separate directory)
  worktree:
    enabled: true
    root: "~/.agent-workspaces/worktrees"
    cleanup_on_complete: true      # Remove worktree after successful task
    cleanup_on_failure: false      # Keep failed worktrees for debugging
    max_age_hours: 24              # Auto-cleanup worktrees older than this
    max_worktrees: 50              # Max concurrent worktrees (increase for parallel work)

# Repository Registry
# Repos are cloned to multi_repo.workspace_root (~/.agent-workspaces by default)
repositories:
  - github_repo: justworkshr/pto
    jira_project: PLUTO
    display_name: PTO Service

  - github_repo: justworkshr/international
    jira_project: INTL
    display_name: International Service

  - github_repo: justworkshr/sui
    jira_project: SUI
    display_name: Sui Service

  - github_repo: justworkshr/punch-out
    jira_project: PLUTO
    display_name: Punch Out Service

  - github_repo: justworkshr/mauvelous-hippo
    jira_project: ME
    display_name: Lifecycle Service

  - github_repo: justworkshr/clockwork_web
    jira_project: ME
    display_name: Clockwork Web

  - github_repo: harrisonju123/agent-framework
    jira_project: AF
    display_name: Agent Framework
# Workflow Configuration
# Defines agent chains and quality gates for diffeent workflow modes
workflows:
  simple:
    description: "Fast workflow for small changes"
    agents: [engineer, testing]
    pr_creator: engineer
    auto_review: true
    require_tests: true

  standard:
    description: "Standard workflow with QA verification"
    agents: [engineer, qa]
    pr_creator: qa
    auto_review: true
    require_tests: true

  full:
    description: "Full workflow with architecture planning"
    agents: [architect, engineer, qa, architect]
    pr_creator: architect
    auto_review: true
    require_tests: true

  quality-focused:
    description: "Enhanced workflow with static analysis"
    agents: [architect, engineer, testing, qa, static-analysis, code-reviewer]
    pr_creator: code-reviewer
    auto_review: true
    require_tests: true
    require_static_analysis: true
    block_on_critical: true

  analysis:
    description: "Full repository analysis workflow"
    agents: [repo-analyzer]
    output: jira_epic  # Creates epic with file-grouped subtasks
    auto_review: false
    require_tests: false

# Static Analysis Configuration
static_analysis:
  enabled: true
  severity_thresholds:
    critical: block    # Block workflow on critical issues
    high: warn         # Warn but allow to proceed
    medium: warn       # Warn but allow to proceed
    low: ignore        # Ignore low severity issues
  tools:
    go: golangci-lint
    python: [pylint, mypy, bandit]
    javascript: eslint
    typescript: eslint
    ruby: rubocop

# Circuit Breaker Configuration
# Orchestrator-level health checks to prevent cascading failures
circuit_breaker:
  enabled: true
  check_interval_seconds: 300  # Check health every 5 minutes
  thresholds:
    max_failure_rate: 0.30     # >30% task failures triggers degradation
    max_stuck_tasks: 10         # >10 stuck tasks triggers action
    max_escalations: 50         # >50 escalations indicates systemic issues
  actions:
    on_degraded: reduce_replicas   # Scale down agents on degradation
    on_critical: pause_intake      # Stop accepting new tasks on critical health

# Analytics Configuration
# Performance metrics, failure detection, and continuous improvement
analytics:
  enabled: true

  # Performance metrics collection
  performance_metrics:
    enabled: true
    report_interval_hours: 24      # Generate report every 24 hours
    retention_days: 30             # Keep metrics for 30 days

  # Failure pattern detection
  failure_detection:
    enabled: true
    pattern_threshold: 3           # Minimum occurrences to report a pattern
    analysis_interval_hours: 168   # Weekly analysis (168 hours)

  # Shadow mode optimization analysis
  shadow_mode_analysis:
    enabled: true
    min_samples: 10                # Minimum samples before recommendations
    safety_threshold: 0.02         # Max acceptable success rate drop (2%)

  # Dynamic token budget optimization
  dynamic_budgets:
    enabled: false                 # Start disabled, enable after baseline
    adjustment_interval_days: 7    # Recalculate budgets weekly
    percentile: 90                 # Use P90 for budget calculation
    min_samples: 20                # Minimum tasks before adjusting

  # Quality trend tracking
  quality_trends:
    enabled: true
    track_test_coverage: true
    track_static_analysis: true
    track_pr_revisions: true
